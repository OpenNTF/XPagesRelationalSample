<!-- ********************************************************************** -->
<!--																		-->
<!-- Â© Copyright IBM Corp. 2014												-->
<!-- 																		-->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); 		-->
<!-- you may not use this file except in compliance with the License. 		-->
<!-- You may obtain a copy of the License at:								-->
<!-- 																		-->
<!-- http://www.apache.org/licenses/LICENSE-2.0 							-->
<!-- 																		-->
<!-- Unless required by applicable law or agreed to in writing, software 	-->
<!-- distributed under the License is distributed on an "AS IS" BASIS,		--> 
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or 		-->
<!-- implied. See the License for the specific language governing			--> 
<!-- permissions and limitations under the License.							-->
<!--																		-->
<!-- ********************************************************************** -->

<!-- First, delete old versions of plugins & feature in the updateSite -->
<!-- Then build updateSite - open site.xml, click "Build All"          -->
<!-- Finally run this buildZip ant script							   -->
<project name="XPagesRelationalSample" default="build.release" basedir=".">
	
	<property name="dir.updateSite.plugins" value="${basedir}/plugin/Source/updateSite/plugins"/>
	<property name="dir.updateSite.features" value="${basedir}/plugin/Source/updateSite/features"/>
	<property name="dir.updateSite.root" value="${basedir}/plugin/Source/updateSite"/>
	<property name="dir.updateSite.output" value="${basedir}/plugin/"/>
	<property name="dir.release.output" value="${basedir}"/>
	<property name="dir.application" value="${basedir}/application"/>
				
	<target name="build.updateSite.zip">
		
		<!-- Remove old zip and jar -->
		<delete>
			<fileset dir="${dir.updateSite.output}" includes="*.zip" />
		</delete>
		<delete>
			<fileset dir="${dir.updateSite.output}" includes="*.jar" />
		</delete>

		<!-- Copy the built plugin to the output dir -->
		<copy todir="${dir.updateSite.output}">
		    <fileset dir="${dir.updateSite.plugins}">
				<include name="*.jar"/>
		    </fileset>
		</copy>
		
		<!-- Generate the zip file -->
		<zip destfile="${dir.updateSite.output}/updateSite.zip">
			<zipfileset dir="${dir.updateSite.plugins}" prefix="plugins/" />
			<zipfileset dir="${dir.updateSite.features}" prefix="features/" />
			<zipfileset dir="${dir.updateSite.root}" includes="site.xml" />
		</zip>
	</target>

	<target name="build.release">
		<!-- Remove old zip and jar -->
		<delete>
			<fileset dir="${dir.release.output}" includes="*.zip" />
		</delete>
		
		<antcall target="build.updateSite.zip" />
		
		<!-- Get the filename of the plugin jar -->
		<fileset id="plugin.jar.file" dir="${dir.updateSite.plugins}" includes="*.jar" />
		<pathconvert property="plugin.jar.path" refid="plugin.jar.file" />
		<basename property="plugin.jar.filename" file="${plugin.jar.path}" suffix=".jar" />
		<echo message="filename = ${plugin.jar.filename}" />
		
		<!-- Generate the filename of the release zip -->
		<script language="javascript">
		    var original = project.getProperty("plugin.jar.filename");
		    project.setProperty("release.filename", original.replace("com.ibm.xsp.extlibx.relational.derby_", "XPagesRelationalSample_"));
		</script>
		
		<!-- Generate the zip file -->
		<zip destfile="${dir.release.output}/${release.filename}.zip">
			<zipfileset dir="${dir.updateSite.output}" includes="*.zip" />
			<zipfileset dir="${dir.updateSite.output}" includes="*.jar" />
			<zipfileset dir="${dir.application}" includes="*.nsf" />
			<zipfileset dir="${basedir}" includes="LICENSE" />
		</zip>

	</target>
</project>
